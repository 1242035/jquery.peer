/*! jquery.peer 0.0.0 (2014-03-01). @michelle */
!function(a){function b(a,b,c,d){this.options=d,this.isMedia="media"===b,this.id=c,this.$el=a,this.isMedia&&this.createStream(),this.createPeer()}function c(b,c,d){var e=a(b);if(!d){var f=a("<video autoplay>");f.attr("id","peer-video-local"),f.attr("muted","true"),e.append(f)}var g=a("<video autoplay>");g.attr("id","peer-video-remote"),e.append(g)}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,b.prototype.createPeer=function(){this.peer=new Peer(this.id,{key:"lwjd5qra8257b9"});var a=this;this.peer.on("error",function(b){a.handleError(b)}),this.peer.on("open",function(){a.ready=!0,void 0!==typeof a.pendingCall&&a.startCall(a.pendingCall)}),this.isMedia&&this.peer.on("call",function(b){a.maybeAnswerCall(b)})},b.prototype.maybeAnswerCall=function(a){this.inCall||this.options.manualCalls||a.answer(this.stream)},b.prototype.createStream=function(){var b=this;navigator.getUserMedia({audio:!0,video:!0},function(c){b.stream=c,b.options.hideOwnVideo||a("#peer-video-local").prop("src",URL.createObjectURL(c)),void 0!==typeof b.pendingCall&&b.startCall(b.pendingCall)})},b.prototype.handleError=function(a){if(-1!==["invalid-id","browser-incompatible"].indexOf(a.type))throw a;if("unavailable-id"!==a.type)throw a.type?new Error("Oops. Something went wrong internally! :(: "+a):a;this.idOffset=this.idOffset||0,this.id=this.id+this.idOffset,this.idOffset+=1,this.createPeer()},b.prototype.startCall=function(b){this.inCall&&"undefined"!=typeof this.pendingCall&&this.cancelCall();if(this.isMedia){if(this.inCall=!0,!this.ready||!this.stream)return void(this.pendingCall=b);this.pendingCall=void 0,this.call=this.peer.call(b,this.stream),this.call.on("stream",function(b){a("#peer-video-remote").prop("src",URL.createObjectURL(b))}),this.call.on("error",function(a){throw a}),setTimeout(this.cancelCall.bind(this),this.options.callTimeout||3e4)}},b.prototype.cancelCall=function(){this.inCall=!1,this.pendingCall=void 0,this.call&&this.call.close()},a.fn.extend({peer:function(a,d,e,f){if(!window.Peer)throw new Error('You need to import PeerJS in order to use jquery.peer. Try putting this in your HTML: `<script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.js"></script>`');if("function"==typeof e&&(f=e,e=void 0),e=e||{},e.room&&-1!==e.room.indexOf("-"))throw new Error("ID must be alphanumeric.");if(-1!==d.indexOf("-"))throw new Error("ID must be alphanumeric.");!e.hideAllDisplays,"media"===a&&c(this,e.hideAllDisplays,e.hideOwnVideo),this._peerConnection=new b(this,a,e.room?e.room+"-"+d:d,e),this._peerType=a,this._peerRoom=e.room,f.call(this)},call:function(a){this._checkPeerType("media"),this._peerConnection.startCall(this._peerRoom?this._peerRoom+"-"+a:a)},endCall:function(){this._checkPeerType("media")},availablePeers:function(){this._checkPeerType()},_checkPeerType:function(a){if(a&&this._peerType!==a||!this._peerConnection)throw new Error("You first have to call $(element).peer('"+a+"', ...) on this element.")}})}(jQuery);