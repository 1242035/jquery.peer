/*! jquery.peer 0.0.0 (2014-03-13). @michelle */
!function(a){function b(a,b){this.options=b,this.room=b.room,this.id=b.id,this.type=b.type,this.internalId=b.type+"-"+(this.room?this.room+"-":"")+this.id,this.isMedia="media"===b.type,this.$el=a,this.isMedia&&(this._createStream(),this._constructMediaElements(b.hideAllDisplays,b.hideOwnVideo)),this._setupHandlers(),this._createPeer()}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;var c={};b.prototype._setupHandlers=function(){var b=this;this.$el.on("click",".peer-buddy",function(){b.call(a(this).text())})},b.prototype._createPeer=function(){this.peer=new Peer(this.internalId+(this.idOffset?this.idOffset:""),{key:"lwjd5qra8257b9",debug:!0});var a=this;this.peer.on("error",function(b){a._handleError(b)}),this.peer.on("open",function(b){a.internalId=b,a.id=b.split("-").pop(),a.ready=!0,a._refreshBuddyList(),c[a.internalId]=1,"undefined"!=typeof a.pendingCall&&a._startCall(a.pendingCall)}),this.isMedia&&this.peer.on("call",function(b){a._maybeAnswerCall(b)})},b.prototype._maybeAnswerCall=function(a){this.inCall||this.options.manualCalls||(this.call=a,this._setupCallHandlers(),this.call.answer(this.stream))},b.prototype._createStream=function(){var a=this;navigator.getUserMedia({audio:!0,video:!0},function(b){a.stream=b,a.options.hideOwnVideo||a.$localVideo.prop("src",URL.createObjectURL(b)),"undefined"!=typeof a.pendingCall&&a._startCall(a.pendingCall)})},b.prototype._handleError=function(a){if(-1!==["invalid-id","browser-incompatible"].indexOf(a.type))throw a;if("unavailable-id"!==a.type){if(a.type){var b="Oops. Something went wrong internally! :(: "+a;throw this._showNotification(b,"error"),new Error(b)}throw a}this.idOffset=this.idOffset||0,this.idOffset+=1,this._createPeer()},b.prototype._startCall=function(a){this.inCall&&"undefined"!=typeof this.pendingCall&&this._cancelCall();if(this.isMedia){if(this.inCall=!0,!this.ready||!this.stream)return void(this.pendingCall=a);this.pendingCall=void 0,this.call=this.peer.call(a,this.stream),this._setupCallHandlers(),setTimeout(this._cancelCall.bind(this),this.options.callTimeout||3e4)}},b.prototype._setupCallHandlers=function(){var a=this;this.call.on("stream",function(b){a._showNotification("Connected to "+a.peerId+"!"),a.$remoteVideo.prop("src",URL.createObjectURL(b))}),this.call.on("error",function(b){throw a._showNotification(b,"error"),b})},b.prototype._cancelCall=function(){this.inCall=!1,this.pendingCall=void 0,this.call&&(this.call.close(),self._showNotification("Ended call with "+this.peerId+"."))},b.prototype._checkPeerType=function(a){if(a&&this.type!==a)throw new Error("Whoops! This element supports "+this.type+" but you are trying to make a "+a+" connection.")},b.prototype.call=function(a){this._checkPeerType("media"),this.peerId=a,this.room&&(a=this.room+"-"+a),a="media-"+a,this._startCall(a)},b.prototype.availablePeers=function(a){if(!this.peer)return void a([]);try{var b=this;this.peer.listAllPeers(function(d){for(var e=[],f=0,g=d.length;g>f;f+=1){var h=d[f];c[h]||0!==h.indexOf(b.type+"-")||b.room&&h.indexOf(b.room)!==b.type.length+1||e.push(d[f].split("-").pop())}a(e)})}catch(d){a([])}},b.prototype._constructMediaElements=function(b,c){c||(this.$localVideo=a("<video autoplay>"),this.$localVideo.addClass("peer-video-local"),this.$localVideo.attr("muted","true"),this.$el.append(this.$localVideo)),this.$remoteVideo=a("<video autoplay>"),this.$remoteVideo.addClass("peer-video-remote"),this.$el.append(this.$remoteVideo),b||(this.$buddyList=a("<div>"),this.$buddyList.addClass("peer-buddy-list"),this.$el.append(this.$buddyList),this.$notifications=a("<div>"),this._resetNotification(),this.$el.append(this.$notifications))},b.prototype._refreshBuddyList=function(){if(!this.options.hideAllDisplays){var b=this;this.availablePeers(function(c){c.forEach(function(c){var d=a("<div>");d.attr("class","peer-buddy"),d.text(c),b.$buddyList.append(d)}),setTimeout(b._refreshBuddyList.bind(b),3e4)})}},b.prototype._showNotification=function(a,b){this.options.hideAllDisplays||(this.$notifications.text(a),this.$notifications.removeClass("peer-hidden"),b&&this.$notifications.addClass("peer-"+b))},b.prototype._resetNotification=function(){this.options.hideAllDisplays||(this.$notifications.attr("class","peer-notification peer-hidden"),this.$notifications.text(""))},a.peer={},a.fn.peer=function(c){if(!window.Peer)throw new Error('You need to import PeerJS in order to use jquery.peer. Try putting this in your HTML: `<script type="text/javascript" src="http://cdn.peerjs.com/latest/peer.js"></script>`');if(1!==this.length)throw new Error("You may select exactly one element. Currently "+this.length+" element(s) are selected.");var d=a.data(this,"connection");if("string"==typeof c){var e=c,f=Array.prototype.slice.call(arguments,1);if(!d)throw new Error("You first have to initialize jquery.peer by calling $(element).peer([options]) on this element.");if("function"!=typeof d[e]||"_"===e[0]||"$"===e[0])throw new Error("Method "+e+" not found.");d[e].apply(d,f)}else{if(d)throw new Error("This element has already been initialized.");if(c.room&&-1!==c.room.indexOf("-"))throw new Error("ID must be alphanumeric.");if(-1!==c.id.indexOf("-"))throw new Error("ID must be alphanumeric.");c.type=a(this).is("form")?"data":"media";var g=new b(this,c);a.data(this,"connection",g)}return this}}(jQuery);